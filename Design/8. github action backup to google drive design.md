# GitHub Action backup to Google Drive design

## Summary
- **Goal:** Define a deterministic GitHub Actions backup workflow that uploads selected assets to Google Drive.

## Document meta
- **Owner:** TBD
- **Status:** draft
- **Last updated:** 2026-02-01
- **Related docs:** Design/0. scope.md

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`BACKUP_TARGETS`** | TBD (paths, dumps, or artifacts) |
| **`BACKUP_SCHEDULE_CRON`** | TBD |
| **`BACKUP_TOOL`** | TBD (e.g., rclone) |
| **`GDRIVE_AUTH_METHOD`** | TBD (service account or OAuth) |
| **`GDRIVE_FOLDER_ID`** | TBD |
| **`BACKUP_NAMING_SCHEME`** | `repo-{yyyy-mm-dd}-{commit}.zip` (proposed) |
| **`RETENTION_POLICY`** | TBD (days or count) |
| **`CHECKSUM_METHOD`** | TBD (e.g., sha256) |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Use a dedicated Google service account. | Least-privilege access to Drive folder. | OAuth with user token. | Requires managed service account secret. |
| Use `rclone` for uploads. | Mature CLI, supports Drive and checksums. | `gdrive` CLI or API client. | Adds CLI install step in workflow. |

## Definitions (optional)
- **Backup target:** The set of files and artifacts packaged for upload.
- **Backup artifact:** The generated archive uploaded to Drive.

## Overview
- **Goal:** Produce and upload a backup artifact to Google Drive on schedule or manual trigger.
- **Target users:** Repo maintainers and operators.
- **Business value:** Recoverable snapshots with minimal manual work.

## Scope
- **In scope:** Backup packaging; Drive upload; retention cleanup; basic integrity checks.
- **Out of scope:** Restore process; disaster recovery runbooks.
- **Assumptions:** GitHub Actions runner can access backup targets and Drive credentials.
- **Constraints:** No secrets stored in the repo; credentials only in GitHub Secrets.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Support `workflow_dispatch` manual runs. |
| **Functional** | Support scheduled runs via `BACKUP_SCHEDULE_CRON`. |
| **Functional** | Package `BACKUP_TARGETS` into a single artifact. |
| **Functional** | Upload the artifact to `GDRIVE_FOLDER_ID`. |
| **Non-functional** | Fail the run on upload errors. |
| **Non-functional** | Avoid storing secrets in the repo or artifacts. |

## Architecture
- **Components:** GitHub Actions runner; backup packager; Drive upload tool.
- **Data flow:** Runner packages `BACKUP_TARGETS`, computes checksum, authenticates, and uploads to Drive.
- **External dependencies:** Google Drive API; chosen CLI tool.
- **Deployment model:** GitHub Actions workflow with scheduled and manual triggers.
- **Diagram description:** CI runner packages targets, computes checksum, then uploads to Drive folder.

## Data Design
- **Entities:** Backup artifact; checksum file; Drive folder.
- **Relationships:** Each artifact maps to a checksum and a Drive folder entry.
- **Storage/retention:** Governed by `RETENTION_POLICY` in Drive.

## Security
- **Threats:** Credential leakage; accidental upload of secrets.
- **Mitigations:** Store credentials only in GitHub Secrets; use allow-list paths for `BACKUP_TARGETS`.
- **Secrets:** Drive credentials stored as `GDRIVE_SERVICE_ACCOUNT_JSON` or OAuth token secret.

## Observability
- **Logging:** Log artifact name, size, checksum, and Drive upload result.
- **Metrics:** None.
- **Alerts:** Optional workflow failure notifications.

## Testing Strategy
- **Unit:** Validate `BACKUP_TARGETS` and required secrets are present.
- **Integration:** Run workflow in a test repo with a dummy Drive folder.
- **E2E:** Schedule a run and verify artifact exists in Drive with checksum.

## Rollout Plan
- **Milestones:** Define variables; add workflow; validate upload; enable schedule.
- **Rollback:** Disable schedule and remove workflow file.

## Open Questions and Risks
- **Questions:** Finalize `BACKUP_TARGETS`, `BACKUP_SCHEDULE_CRON`, `RETENTION_POLICY`, and `CHECKSUM_METHOD`.
- **Risks and mitigations:** Upload failures due to quota; mitigate with retries and alerting.
