# Restore from Google Drive design

## Summary
- **Goal:** Define a controlled process to restore a backup artifact from Google Drive.

## Document meta
- **Owner:** TBD
- **Status:** draft
- **Last updated:** 2026-02-01
- **Related docs:** Design/8. google drive folder and service account setup design.md, Design/9. github action backup to google drive design.md

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`RESTORE_TARGET`** | Repo root (restore to `./restore/` staging folder) |
| **`RESTORE_SOURCE_ID`** | Required input at dispatch time |
| **`RESTORE_TOOL`** | rclone |
| **`GDRIVE_AUTH_METHOD`** | Service account JSON |
| **`GDRIVE_FOLDER_ID`** | TBD |
| **`CHECKSUM_METHOD`** | sha256 |
| **`DRY_RUN_MODE`** | on (default) |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Require explicit `RESTORE_SOURCE_ID` on each run. | Prevents accidental restores. | Auto-pick latest backup. | Requires operator input. |
| Verify checksum before restore. | Detects corruption or mismatched artifacts. | Skip verification. | Adds a verification step. |

## Definitions (optional)
- **Restore target:** Destination for restored data (repo, VM path, or DB).
- **Restore artifact:** The backup archive downloaded from Drive.

## Overview
- **Goal:** Retrieve a backup artifact from Drive and restore it to the specified target.
- **Target users:** Repo maintainers and operators.
- **Business value:** Reliable recovery path when data loss or rollback is needed.

## Scope
- **In scope:** Drive download; integrity verification; restore to target location.
- **Out of scope:** Automated disaster recovery; cross-region replication.
- **Assumptions:** Drive credentials and `RESTORE_SOURCE_ID` are available at run time.
- **Constraints:** Requires explicit operator trigger and target confirmation.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Support manual `workflow_dispatch` or manual CLI/script invocation. |
| **Functional** | Download artifact identified by `RESTORE_SOURCE_ID`. |
| **Functional** | Verify integrity using `CHECKSUM_METHOD`. |
| **Functional** | Restore to `RESTORE_TARGET` and log results. |
| **Non-functional** | Fail the run on checksum mismatch or download errors. |
| **Non-functional** | Avoid overwriting targets without confirmation. |
| **Non-functional** | Default to `DRY_RUN_MODE` unless explicitly disabled. |

## Architecture
- **Components:** GitHub Actions runner or operator host; Drive download tool; restore script.
- **Data flow:** Authenticate, download artifact, verify checksum, restore to `RESTORE_TARGET`.
- **External dependencies:** Google Drive API; chosen CLI tool.
- **Deployment model:** Manual workflow dispatch or local operator script.
- **Diagram description:** Operator triggers restore, runner downloads artifact, verifies checksum, and writes to target.

## Data Design
- **Entities:** Restore artifact; checksum file; restore target.
- **Relationships:** Each restore references a specific backup artifact and checksum.
- **Storage/retention:** Restore artifacts remain in Drive per backup retention policy.

## Security
- **Threats:** Restoring wrong artifact; credential exposure.
- **Mitigations:** Require `RESTORE_SOURCE_ID`; use GitHub Secrets for credentials.
- **Secrets:** Drive credentials stored in GitHub Secrets or operator vault.

## Observability
- **Logging:** Log source ID, checksum result, and restore target.
- **Metrics:** None.
- **Alerts:** Optional workflow failure notifications.

## Testing Strategy
- **Unit:** Validate required inputs and presence of credentials.
- **Integration:** Restore a dummy artifact to a test path.
- **E2E:** Restore to a staging target and verify application state.

## Rollout Plan
- **Milestones:** Define variables; add restore workflow/script; test with dummy artifact.
- **Rollback:** Disable restore workflow and remove script.

## Open Questions and Risks
- **Questions:** Should restore ever write directly to the VM data paths (`N8N_DATA_PATH`, `POSTGRES_DATA_PATH`)?
- **Risks and mitigations:** Human error in target selection; mitigate with confirmations and dry-run.
