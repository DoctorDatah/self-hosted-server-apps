# SSH Setup Design (VM)

## Summary
- **Goal:** Define a deterministic SSH setup for GitHub Actions runner (client) to access the VM (server).

## Front Matter
- **Title:** SSH Setup Design (VM)
- **Project:** n8n self-hosting app
- **Owner:** Malik
- **Status:** Draft
- **Last updated:** 2026-01-25
- **Related docs:** `Design/1. package handling design.md`

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`SUPPORTED_OS`** | Ubuntu 22.04 LTS or Debian 12 |
| **`PRIMARY_OS`** | Ubuntu 22.04 LTS |
| **`SSH_PORT`** | 22 |
| **`SSH_USER`** | deploy |
| **`SSH_AUTH_METHOD`** | Key-based only |
| **`SSH_KEY_TYPE`** | ed25519 |
| **`SSH_KNOWN_HOSTS_PATH`** | `ops/ssh/known_hosts` |
| **`SSH_PRIVATE_KEY_SOURCE`** | GitHub Actions secrets |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Use key-based SSH only. | Standard for non-interactive CI access. | Password auth. | Requires key management in CI and VM. |
| Use a dedicated `SSH_USER`. | Limits blast radius and audit scope. | Reuse default admin user. | Requires user creation and scoped permissions. |
| Store host key fingerprints in repo. | Prevents MITM and keeps audits deterministic. | Disable host key checking. | Requires maintaining `SSH_KNOWN_HOSTS_PATH`. |

## Definitions (optional)
- **GitHub Actions runner:** The CI worker that initiates SSH connections to the VM.
- **Host key fingerprint:** The VMâ€™s SSH identity stored in `known_hosts`.

## Overview
- **Goal:** Enable secure, non-interactive SSH access from GitHub Actions to the VM.
- **Target users:** Single-VM admin/operator.
- **Business value:** Deterministic CI deployments with minimal manual access.

## Scope
- **In scope:** SSH server configuration; user and key setup; CI secret handling; host key verification.
- **Out of scope:** VPN access; bastion hosts; interactive admin workflows.
- **Assumptions:** VM is reachable from GitHub Actions network; Docker-based deploys run over SSH.
- **Constraints:** No password auth; no interactive prompts in CI.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Configure SSH server to allow `SSH_USER` key-based logins. |
| **Functional** | Store VM host key fingerprint in `SSH_KNOWN_HOSTS_PATH`. |
| **Functional** | Create `SSH_KNOWN_HOSTS_PATH` in repo before CI access. |
| **Functional** | Store SSH private key in `SSH_PRIVATE_KEY_SOURCE`. |
| **Non-functional** | Disable password authentication. |
| **Non-functional** | Keep SSH configuration auditable in repo. |
| **Non-functional** | Ensure CI runs without interactive prompts. |

## Architecture
- **Components:** VM SSH server; `SSH_USER`; GitHub Actions runner; secrets store.
- **Data flow:** CI loads SSH key -> verifies host key -> connects to VM -> runs deployment commands.
- **External dependencies:** GitHub Actions; SSH client.
- **Deployment model:** CI executes SSH and remote commands during deploy.
- **Diagram description:** GitHub Actions runner connects via SSH to the VM, authenticated by key, with host key verification from repo.

## Data Design
- **Entities:** `ops/ssh/known_hosts` for host key fingerprints.
- **Relationships:** CI uses known hosts file and private key to connect as `SSH_USER`.
- **Storage/retention:** Known hosts in repo; private key only in CI secrets.

## Security
- **Threats:** Key leakage; MITM; unauthorized access.
- **Mitigations:** CI secret storage; host key verification; dedicated user.
- **Secrets:** SSH private key stored in GitHub Actions secrets.

## Observability
- **Logging:** SSH auth logs on the VM.
- **Metrics:** None.
- **Alerts:** Not implemented; manual review of auth logs.

## Testing Strategy
- **Unit:** Validate known_hosts format and presence.
- **Integration:** SSH from CI to VM using the stored key.
- **E2E:** Run a deploy command over SSH and verify success.

## Rollout Plan
- **Milestones:** Create `SSH_USER`; install public key; record host key; store private key in CI.
- **Rollback:** Remove SSH key from `SSH_USER` and revoke CI secret.

## Risks and Mitigations
- **Risk:** Key rotation breaks CI access. **Mitigation:** Document rotation steps and validate in a staging run.
- **Risk:** Host key changes trigger CI failures. **Mitigation:** Update `SSH_KNOWN_HOSTS_PATH` with review.

## Open Questions
- **Question:** Should `SSH_PORT` remain 22 or be changed to a non-default port?
