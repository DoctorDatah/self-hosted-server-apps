# GH Repo Cloudflare Pinned Version Design

## Summary
- **Goal:** Centralize the pinned cloudflared image version in the repo to keep dependencies deterministic and auditable.

## Front Matter
- **Title:** GH Repo Cloudflare Pinned Version Design
- **Project:** n8n self-hosting app
- **Owner:** Malik
- **Status:** Draft
- **Last updated:** 2026-01-25
- **Related docs:** `Design/2. cloudflare installation design.md`

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`CLOUDFLARE_IMAGE`** | cloudflare/cloudflared |
| **`CLOUDFLARE_IMAGE_TAG`** | Pin to a specific version (manual selection) |
| **`PIN_SOURCE_FILE`** | `ops/dependencies.md` |
| **`PIN_ENTRY_FORMAT`** | Table row with image name and tag |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Store the pinned cloudflared version in `PIN_SOURCE_FILE`. | Single source of truth for dependency pins. | Hardcode in compose file only. | Centralized updates and review. |
| Require manual updates to `CLOUDFLARE_IMAGE_TAG`. | Avoids silent upgrades. | Auto-update tags. | Slower but deterministic changes. |

## Definitions (optional)
- **Pinned version:** Explicit image tag used for cloudflared.

## Overview
- **Goal:** Keep the cloudflared version centralized in the repo.
- **Target users:** Single-VM admin/operator.
- **Business value:** Deterministic upgrades and auditability.

## Scope
- **In scope:** Storing pinned version in repo; referencing it from deployment files.
- **Out of scope:** Auto-update pipelines; vulnerability scanning.
- **Assumptions:** `PIN_SOURCE_FILE` exists and is reviewed with changes.
- **Constraints:** Pinned tags only; no floating tags.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Record `CLOUDFLARE_IMAGE` and `CLOUDFLARE_IMAGE_TAG` in `PIN_SOURCE_FILE`. |
| **Functional** | Reference the pinned version from deployment config. |
| **Non-functional** | Changes to pins require PR review. |
| **Non-functional** | Do not use floating tags like `latest`. |

## Architecture
- **Components:** `PIN_SOURCE_FILE`; deployment config (compose).
- **Data flow:** Update pin in repo -> deploy uses pinned tag -> cloudflared runs at that version.
- **External dependencies:** Container image registry.
- **Deployment model:** Manual or CI deploy consumes pinned tag.
- **Diagram description:** Repo holds a pinned version record referenced by compose during deploy.

## Data Design
- **Entities:** `PIN_SOURCE_FILE` entry for cloudflared using `PIN_ENTRY_FORMAT`.
- **Relationships:** Deployment reads pinned tag from repo.
- **Storage/retention:** Repo history provides version audit trail.

## Security
- **Threats:** Unreviewed upgrades; supply-chain drift.
- **Mitigations:** PR review; pinned tags; explicit update steps.
- **Secrets:** None.

## Observability
- **Logging:** Not applicable.
- **Metrics:** Not applicable.
- **Alerts:** Not implemented.

## Testing Strategy
- **Unit:** Validate that `PIN_SOURCE_FILE` includes a pinned tag.
- **Integration:** Deploy and confirm the container uses the pinned tag.
- **E2E:** Verify service operates with the pinned version.

## Rollout Plan
- **Milestones:** Add pin to `PIN_SOURCE_FILE`; update deployment config; deploy.
- **Rollback:** Revert `PIN_SOURCE_FILE` and deployment config to prior tag.

## Risks and Mitigations
- **Risk:** Pin is outdated. **Mitigation:** Periodic review cadence.
- **Risk:** Pin mismatch in deployment config. **Mitigation:** Validate in CI or pre-deploy checks.

## Open Questions
- **Question:** Do we need additional fields in `PIN_ENTRY_FORMAT` (e.g., source URL or checksum)?
