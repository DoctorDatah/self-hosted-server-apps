# Implementation Structure Design

## Summary
- **Goal:** Define a comprehensive repo structure: folders, files, and what belongs where.

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`REPO_ROOT`** | Repo root |
| **`OPS_DIR`** | `ops/` |
| **`DESIGN_DIR`** | `Design/` |
| **`WORKFLOW_DIR`** | `.github/workflows/` |
| **`DOCS_DIR`** | `AI/` |
| **`DEPLOY_DIR`** | `ops/deploy/` |
| **`COMPOSE_DIR`** | `ops/compose/` |
| **`SECRETS_REF_DIR`** | `ops/secrets/` (references only, no secrets) |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Keep ops files under `OPS_DIR`. | Centralized operational assets. | Split across service folders. | Standardized paths for automation. |
| Keep design docs under `DESIGN_DIR`. | Clear separation of design vs implementation. | Store with code. | Easier review and navigation. |
| Keep CI workflows under `WORKFLOW_DIR`. | GitHub Actions convention. | Custom workflow folder. | Compatible with GitHub Actions. |
| Separate design guidance in `DOCS_DIR`. | Avoid mixing instructions with implementation. | Keep in README. | Clearer documentation boundaries. |

## Definitions (optional)
- **Ops files:** Configuration and assets used to operate the VM and deploy services.

## Overview
- **Goal:** Provide a deterministic structure for implementation artifacts.
- **Target users:** Repo maintainers and CI maintainers.
- **Business value:** Predictable paths and less configuration drift.

## Scope
- **In scope:** Folder layout; file placement rules; ownership by folder.
- **Out of scope:** Code style rules; app-level architecture.
- **Assumptions:** Repo is the single source of truth.
- **Constraints:** No secrets committed to the repo.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Store deployment artifacts in `OPS_DIR`. |
| **Functional** | Store workflows in `WORKFLOW_DIR`. |
| **Functional** | Store design docs in `DESIGN_DIR`. |
| **Functional** | Store AI guidance in `DOCS_DIR`. |
| **Non-functional** | Keep paths stable to avoid CI drift. |
| **Non-functional** | Keep secrets out of version control. |

## Architecture
- **Components:** Repo root; ops folder; workflows; design docs; AI docs.
- **Data flow:** CI and scripts reference fixed paths during deploy.
- **External dependencies:** GitHub Actions.
- **Deployment model:** CI uses paths defined here.
- **Diagram description:** Repo with standardized top-level folders and fixed paths referenced by CI.

## Data Design
- **Entities:** Ops files; workflow definitions; design docs; AI docs.
- **Relationships:** Workflows call scripts and configs in ops folder.
- **Storage/retention:** Repo history is the audit trail.

## Security
- **Threats:** Secret leakage; accidental path changes.
- **Mitigations:** Repo reviews; avoid secrets in tracked files.
- **Secrets:** Stored only in external secret managers.

## Observability
- **Logging:** CI logs on workflow runs.
- **Metrics:** None.
- **Alerts:** Not implemented.

## Testing Strategy
- **Unit:** Validate expected directories exist in CI pre-checks.
- **Integration:** Run a dry-run deploy using defined paths.
- **E2E:** Full deploy using the standardized structure.

## Rollout Plan
- **Milestones:** Confirm directory layout; update workflows to use defined paths.
- **Rollback:** Revert to previous folder layout and update workflows.

## Open Questions
- **Question:** Do we need a dedicated `scripts/` directory under `OPS_DIR`?

## Folder Structure (canonical)
- **Hierarchy (intended):**
```text
repo-root/
├── AI/
│   ├── 1. reading guide for ai and syntax for developer.md
│   ├── 2a. design document writing guide.md
│   ├── 2b. general document formatting guide.md
│   ├── 3. implementation document writing guide.md
│   └── 4. implementation document guide.md
├── Design/
│   ├── 0. scope.md
│   ├── 1. package handling design.md
│   ├── 2. cloudflare installation design.md
│   ├── 3. gh repo cloudflare pinned version.md
│   ├── 4. ssh setup design.md
│   ├── 5. gh variables and secrets for infisical.md
│   ├── 6.1 gh action infisical install and secret fetch.md
│   ├── 6.2 gh action deploy script install cloudflare.md
│   ├── 7. n8n deployment design.md
│   ├── 8. github action backup to google drive design.md
│   ├── 9. restore from google drive design.md
│   └── 10. implementation structure design.md
├── .github/
│   └── workflows/
│       └── deploy.yml
└── ops/
    ├── cloudflared/
    │   └── config.yml
    ├── compose/
    │   ├── n8n.compose.yml
    │   └── cloudflared.compose.yml
    ├── deploy/
    │   ├── deploy.sh
    │   └── validate-env.sh
    ├── ssh/
    │   └── known_hosts
    ├── secrets/
    │   └── infisical.md
    └── dependencies.md
```

## File Descriptions
| **Path** | **Purpose** |
| --- | --- |
| `AI/1. reading guide for ai and syntax for developer.md` | AI reading rules and markers. |
| `AI/2a. design document writing guide.md` | How to write design docs. |
| `AI/2b. general document formatting guide.md` | Formatting rules for repo docs. |
| `AI/3. implementation document writing guide.md` | Implementation doc table format rules. |
| `AI/4. implementation document guide.md` | Implementation doc usage and status rules. |
| `Design/0. scope.md` | Project scope and sequencing. |
| `Design/1. package handling design.md` | Host vs container package policy. |
| `Design/2. cloudflare installation design.md` | Cloudflare tunnel setup plan. |
| `Design/3. gh repo cloudflare pinned version.md` | Pin storage for cloudflared image. |
| `Design/4. ssh setup design.md` | SSH model for CI to VM. |
| `Design/5. gh variables and secrets for infisical.md` | GitHub vars/secrets for Infisical. |
| `Design/6.1 gh action infisical install and secret fetch.md` | CI step to install and use Infisical. |
| `Design/6.2 gh action deploy script install cloudflare.md` | CI step to use Cloudflare client for SSH. |
| `Design/7. n8n deployment design.md` | n8n + Postgres deploy flow. |
| `Design/8. github action backup to google drive design.md` | Backup workflow design (Google Drive). |
| `Design/9. restore from google drive design.md` | Restore workflow design (Google Drive). |
| `Design/10. implementation structure design.md` | Repo structure blueprint. |
| `.github/workflows/deploy.yml` | CI deploy workflow entrypoint. |
| `ops/cloudflared/config.yml` | Cloudflared config (no secrets). |
| `ops/compose/n8n.compose.yml` | Compose stack for n8n + Postgres. |
| `ops/compose/cloudflared.compose.yml` | Compose service for cloudflared. |
| `ops/deploy/deploy.sh` | Deploy script run over SSH. |
| `ops/deploy/validate-env.sh` | Pre-deploy env validation. |
| `ops/ssh/known_hosts` | VM host key fingerprint list. |
| `ops/secrets/infisical.md` | Secret references and naming. |
| `ops/dependencies.md` | Pinned versions for images/tools. |
- **`Design/`**: Design docs for each step (1..N) and scope.
- **`AI/`**: AI guidance, syntax rules, and doc templates.
- **`.github/workflows/`**: CI workflows; no secrets.
- **`ops/`**: Operational assets and configs used by CI/VM.
- **`ops/compose/`**: Docker Compose files and related templates.
- **`ops/deploy/`**: Deploy scripts and helper files.
- **`ops/ssh/`**: SSH known_hosts and public key material only.
- **`ops/cloudflared/`**: Cloudflare tunnel config (no secrets).
- **`ops/secrets/`**: Secret references, naming, and access notes only.
- **`ops/dependencies.md`**: Pinned versions for images and tools.

## File Placement Rules
- **Compose files:** `ops/compose/` only.
- **Deploy scripts:** `ops/deploy/` only.
- **Pinned versions:** `ops/dependencies.md` only.
- **Cloudflare config:** `ops/cloudflared/config.yml` only, no tokens.
- **SSH host keys:** `ops/ssh/known_hosts` only.
- **CI workflows:** `.github/workflows/` only.
- **Design docs:** `Design/` only.
- **AI guidance:** `AI/` only.
