# Cloudflare Tunnel Troubleshooting (VM SSH)

Use this when SSH over the tunnel fails or the tunnel won’t connect.

---

## 1) Check tunnel container status (VM)
```bash
docker ps | rg -i cloudflared
docker logs --tail 200 cloudflared
```
If you installed via this repo, you can also tail logs with:
```bash
sudo docker compose -f "/home/malik/self-hosted-server-apps/VM - N8N/Cloudflare for VM/docker-compose.yml" logs -f
```
If you don’t see the container, start it with:
```bash
sudo -E "/home/malik/self-hosted-server-apps/VM - N8N/Cloudflare for VM/cloudflare_install_and_setup.sh"
```
Note: `cloudflare_install_and_setup.sh` writes a `.env` file for future `docker compose` commands.

---

## 2) Confirm the tunnel is connected
In logs you should see something like:
```
Connected to <region>
```
If not connected:
- Token is wrong/expired
- Tunnel deleted in Cloudflare
- Firewall blocks outbound (rare)

Fix:
- Re-copy the token from Cloudflare Zero Trust
- Export it and re-run install:
```bash
export CLOUDFLARE_TUNNEL_TOKEN="<your-token>"
sudo -E "/home/malik/self-hosted-server-apps/VM - N8N/Cloudflare for VM/cloudflare_install_and_setup.sh"
```

---

## 3) Verify SSH is running on the VM
```bash
sudo systemctl status ssh
sudo ss -tlnp | rg ':22 '
```
You should see `sshd` listening on port `22`.

---

## 4) Check your config.yml service target
`VM - N8N/Cloudflare for VM/config.yml` must use:
```yaml
ingress:
  - hostname: ssh.example.com
    service: ssh://localhost:22
```
Because the container uses `network_mode: host`, `localhost:22` points to the VM.

After changes:
```bash
sudo -E "/home/malik/self-hosted-server-apps/VM - N8N/Cloudflare for VM/cloudflare_install_and_setup.sh"
```

---

## 5) Cloudflare Access
If Access is enabled, ensure:
- You’re allowed in the policy
- You’re using `cloudflared access ssh` or an SSH config with ProxyCommand

---

## 6) Common errors and fixes

**Permission denied (publickey)**
- Wrong user or key
- Access policy blocks user

**Connection timed out**
- Tunnel not connected
- SSH service down

**Host key verification failed**
- Refresh `known_hosts` for the SSH hostname

---

## 7) Quick checklist
- [ ] `cloudflared` container running
- [ ] Tunnel shows “Connected”
- [ ] `sshd` listening on port 22
- [ ] `config.yml` uses `ssh://localhost:22`
- [ ] Access policy allows you

If you paste:
- `docker ps` output
- last 50 lines of `docker logs cloudflared`
- `config.yml`
I can pinpoint the exact fix.
