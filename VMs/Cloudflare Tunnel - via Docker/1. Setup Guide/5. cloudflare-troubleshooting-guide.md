# Cloudflare Tunnel Troubleshooting (VM)

Use this when the domain shows errors like **502 Bad Gateway** or the tunnel won’t connect.

---

## 1) Check tunnel container status (VM)
```bash
docker ps | rg -i cloudflared
docker logs --tail 200 cloudflared
```
If you don’t see the container, start it with:
```bash
sudo -E ~/self-hosted-server-apps/VMs/Cloudflare\ Tunnel\ \(via\ Docker\)/install.sh
```

---

## 2) Confirm the tunnel is connected
In logs you should see something like:
```
Connected to <region>
```
If not connected:
- Token is wrong/expired
- Tunnel deleted in Cloudflare
- Firewall blocks outbound (rare)

Fix:
- Re-copy the token from Cloudflare Zero Trust
- Export it and re-run install:
```bash
export CLOUDFLARE_TUNNEL_TOKEN="<your-token>"
sudo -E ~/self-hosted-server-apps/VMs/Cloudflare\ Tunnel\ \(via\ Docker\)/install.sh
```

---

## 3) Verify origin is reachable from the tunnel
This is the #1 reason for **502 Bad Gateway**.

If cloudflared runs in Docker and your app is another container:
- Both must be on the **same Docker network**
- `service:` must use the **container name**

Check networks:
```bash
docker network ls
docker network inspect appnet | rg -i 'Name|Containers'
```

If cloudflared runs on the VM host:
- Use `http://localhost:PORT` in `config.yml`
- Ensure the app listens on the host

Test locally:
```bash
curl -I http://127.0.0.1:8000   # replace with your app port
```

---

## 4) Check your config.yml service target
`VMs/Cloudflare Tunnel (via Docker)/config.yml` must match where the app is reachable.

Example (docker network):
```yaml
ingress:
  - hostname: app.example.com
    service: http://app:PORT
```

Example (host network):
```yaml
ingress:
  - hostname: app.example.com
    service: http://localhost:PORT
```

After changes:
```bash
sudo -E ~/self-hosted-server-apps/VMs/Cloudflare\ Tunnel\ \(via\ Docker\)/install.sh
```

---

## 5) Cloudflare DNS + Tunnel route
In Cloudflare Zero Trust:
- Tunnel exists and is **connected**
- Public Hostname is set to your domain
- Service URL matches config (HTTP, correct port)

If you update DNS/hostname, give it a minute to propagate.

---

## 6) Common errors and fixes

**502 Bad Gateway**
- Wrong `service:` target (most common)
- App not running
- Wrong Docker network / container name

**403 / Access denied**
- Cloudflare Access policy blocking
- Remove Access policy or allow your email/IP

**521 / 522**
- Origin not reachable
- Firewall blocking local port
- App crashed

---

## 7) Quick checklist
- [ ] `cloudflared` container running
- [ ] Tunnel shows “Connected”
- [ ] Correct `service:` target in config
- [ ] App reachable on that target (curl works)
- [ ] Public hostname set in Cloudflare

---

If you paste:
- `docker ps` output
- last 50 lines of `docker logs cloudflared`
- `config.yml`
I can pinpoint the exact fix.
