# Cloudflare Tunnel (VM)

Flat, self-contained setup to run Cloudflare Tunnel on a VM via Docker Compose.

## Quick Steps (Do This)
- Clone the repo to the VM (first time only) (pull later)
- Update `config.yml` with your hostname(s) and service target(s)
- Run `sudo -E "/home/malik/self-hosted-server-apps/VMs/Cloudflare/cloudflare_env_setup.sh"` (writes `.env` from Infisical)
- Run `sudo -E "/home/malik/self-hosted-server-apps/VMs/Cloudflare/cloudflare_install_and_setup.sh"` (prompts for Cloudflare API setup; reads values from local `.env` and saves the tunnel token locally)
- Select tags and the target app network when prompted (default: `appnet`)
- The app network must already exist (created by `VMs/Installations` and app deployment)

## Files (Hierarchy)
```
.
├─ docker-compose.yml                  # cloudflared service
├─ config.yml                          # ingress config template (no secrets)
├─ config.generated.yml                # generated by cloudflare_install_and_setup.sh when tag selection is used
├─ requirements.txt                    # pinned cloudflared image tag
├─ cloudflare_env_setup.sh              # writes .env from Infisical
├─ cloudflare_install_and_setup.sh      # start the tunnel (prompts for tag selection)
└─ 1. Setup Guide
   ├─ 1. repo-clone-guide.md           # clone/update the repo on the VM
   ├─ 2. cloudflare-tunnel-creation-guide.md
   ├─ 4. [In self hosted app config]  cloudflare-to-app-network-guide.md
   └─ 5. cloudflare-troubleshooting-guide.md
```

## Usage (on the VM)
### Run (prompts for setup)
```bash
sudo -E "/home/malik/self-hosted-server-apps/VMs/Cloudflare/cloudflare_env_setup.sh"
sudo -E "/home/malik/self-hosted-server-apps/VMs/Cloudflare/cloudflare_install_and_setup.sh"
```
The env setup script writes `.env` in this folder before starting.

## What cloudflare_install_and_setup.sh does
- Checks Docker + Compose (errors if missing; run `VMs/install/install_all.sh`)
- Prompts for tag selection and generates `config.generated.yml` if chosen
- Prompts for the target app network (default: `appnet`)
- Prompts for Cloudflare API setup (tunnel + DNS)
- Exits if the target app network does not exist (run installations to create `appnet`, then deploy the app)
- Reads pinned image/tag from `requirements.txt` (can override tag)
- Starts the tunnel container with Docker Compose

## Notes
- Update `config.yml` with your hostname(s) and service target(s).
- `cloudflare_install_and_setup.sh` can filter `config.yml` by tag blocks and write `config.generated.yml`.
- `cloudflare_env_setup.sh` preserves an existing tunnel token/ID in `.env` if Infisical doesn’t return them.
- `cloudflare_env_setup.sh` does not pull the tunnel token/ID from Infisical; the install script saves them locally.
