# Cloudflare Tunnel Install Guide (VM)

## Summary
- **Goal:** Install Docker (if missing) and run Cloudflare Tunnel on the VM using this repo.
- **Scope:** VM-side steps only (no DNS setup details, no secrets in repo).

## Preconditions
- Repo is present on the VM (same structure as this repo).
- `Apps/cloudflare/config.yml` has the correct hostname and service.
- `Apps/cloudflare/requirements.txt` has pinned Cloudflare values.
- You have a valid Cloudflare Tunnel token (do **not** store it on disk).

## Variables
| **Name** | **Example** | **Notes** |
| --- | --- | --- |
| `CLOUDFLARE_TUNNEL_TOKEN` | `<token>` | Runtime only; never write to disk. |
| `CLOUDFLARE_IMAGE` | `cloudflare/cloudflared` | Must match `Apps/cloudflare/requirements.txt`. |
| `CLOUDFLARE_IMAGE_TAG` | `2026.1.2` | Must match `Apps/cloudflare/requirements.txt`. |
| `CLOUDFLARE_CONFIG_PATH` | `/path/to/repo/Apps/cloudflare/config.yml` | Repo path on the VM. |

## Install Steps (VM)
1) SSH to the VM.
2) Clone the repo if you haven't already:
```bash
git clone https://github.com/DoctorDatah/self-hosted-server-apps ~/self-hosted-server-apps
```
3) (Optional but recommended) Verify the config checksum after cloning/sync:
```bash
sha256sum ~/self-hosted-server-apps/Apps/cloudflare/config.yml
```
4) Get your Cloudflare Tunnel token:
   - In Zero Trust, when you create/open the tunnel, Cloudflare shows **commands** to run.
   - **Do not run those commands** on this VM.
   - Instead, copy the **token** from the command (it appears after `--token`).
   - Example command format:
     - `cloudflared tunnel --no-autoupdate run --token <YOUR_TOKEN>`
5) From the repo root, export the token (in-session only):
```bash
export CLOUDFLARE_TUNNEL_TOKEN="<your-tunnel-token>"
```
6) Run the install script (installs Docker if missing and starts the tunnel):
```bash
sudo -E "/home/malik/self-hosted-server-apps/Apps/cloudflare/install.sh"
```

7) Verify connection:
```bash
sudo -E "/home/malik/self-hosted-server-apps/Apps/cloudflare/logs.sh"
```

## Notes
- `install.sh` installs Docker + Compose if missing. To skip that step, run:
```bash
sudo -E "/home/malik/self-hosted-server-apps/Apps/cloudflare/install.sh" --skip-docker
```
- Cloudflared runs as a container; no host-installed cloudflared packages.
- Tunnel tokens must never appear in `config.yml` or `.env` files.

## Troubleshooting
- **Docker install failed:** Ensure you ran with sudo (or install Docker manually).
- **No tunnel connection:** Confirm the token is valid and not expired.
- **Config error:** Validate `Apps/cloudflare/config.yml` has the correct hostname and service.
- **Wrong image tag:** Ensure `CLOUDFLARE_IMAGE_TAG` matches `Apps/cloudflare/requirements.txt`.

## Rollback
```bash
sudo -E docker compose -f Apps/cloudflare/docker-compose.yml down
```

## Remove and Try Again (sudo)
```bash
sudo -E docker compose -f /home/malik/self-hosted-server-apps/Apps/cloudflare/docker-compose.yml down
sudo -E docker rmi cloudflare/cloudflared:<PINNED_TAG_FROM_REQUIREMENTS>
```
