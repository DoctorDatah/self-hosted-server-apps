# Cloudflare Tunnel Install Guide (VM)

## Summary
- **Goal:** Install and run cloudflared on the VM via Docker Compose using the repo configs.
- **Scope:** VM-side steps only (no DNS setup details, no secrets in repo).

## Preconditions
- Docker Engine and Compose installed on the VM.
- Repo is present on the VM (same structure as this repo).
- `Apps/n8n-app/ops/cloudflared/config.yml` has the correct hostname.
- `Apps/n8n-app/ops/dependencies.md` has pinned Cloudflare values.
- You have a valid Cloudflare Tunnel token (do **not** store it on disk).

## Variables
| **Name** | **Example** | **Notes** |
| --- | --- | --- |
| `CLOUDFLARE_TUNNEL_TOKEN` | `<token>` | Runtime only; never write to disk. |
| `CLOUDFLARE_IMAGE` | `cloudflare/cloudflared` | Must match `Apps/n8n-app/ops/dependencies.md`. |
| `CLOUDFLARE_IMAGE_TAG` | `2026.1.2` | Must match `Apps/n8n-app/ops/dependencies.md`. |
| `CLOUDFLARE_CONFIG_PATH` | `/path/to/repo/Apps/n8n-app/ops/cloudflared/config.yml` | Repo path on the VM. |

## Install Steps (VM)
1) SSH to the VM.
2) Clone the repo if you haven't already:
```bash
git clone https://github.com/DoctorDatah/self-hosted-server-apps ~/self-hosted-server-apps
```
3) Get your Cloudflare Tunnel token:
   - In Zero Trust, when you create/open the tunnel, Cloudflare shows **commands** to run.
   - **Do not run those commands** on this VM.
   - Instead, copy the **token** from the command (it appears after `--token`).
   - Example command format:
     - `cloudflared tunnel --no-autoupdate run --token <YOUR_TOKEN>`
4) From the repo root, export the token (in-session only):
```bash
export CLOUDFLARE_TUNNEL_TOKEN="<your-tunnel-token>"
```
5) Run the VM install script (reads pins from `Apps/n8n-app/ops/dependencies.md`):
```bash
sudo -E "/home/malik/self-hosted-server-apps/Apps/n8n-app/n8n-vm/2. cloudflare install.sh"
```

6) Verify connection (no manual exports):

```bash
sudo -E "/home/malik/self-hosted-server-apps/Apps/n8n-app/n8n-vm/2. cloudflare logs.sh"
```

## Notes
- These steps assume the repo is cloned on the VM.

## Troubleshooting
- **No tunnel connection:** Confirm the token is valid and not expired.
- **Config error:** Validate `Apps/n8n-app/ops/cloudflared/config.yml` has the correct hostname and service.
- **Wrong image tag:** Ensure `CLOUDFLARE_IMAGE_TAG` matches `Apps/n8n-app/ops/dependencies.md`.

## Rollback
```bash
sudo -E docker compose -f Apps/n8n-app/ops/compose/cloudflared.compose.yml down
```

## Remove and Try Again (sudo)
```bash
sudo -E docker compose -f /home/malik/self-hosted-server-apps/Apps/n8n-app/ops/compose/cloudflared.compose.yml down
sudo -E docker rmi cloudflare/cloudflared:2026.1.2
```

## If Logs Script Is Missing
If `2. cloudflare logs.sh` is missing on the VM, update the repo and make it executable:
```bash
cd /home/malik/self-hosted-server-apps
git pull
chmod +x "/home/malik/self-hosted-server-apps/Apps/n8n-app/n8n-vm/2. cloudflare logs.sh"
```
