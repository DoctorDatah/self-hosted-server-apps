# Package Handling Design (VM)

## Summary
- **Goal:** Separate host packages from app packages to keep the VM minimal and deterministic.

## Global Variables (select here)
| **Variable**                 | **Value**                                                                  |
| ---------------------------- | -------------------------------------------------------------------------- |
| **`SUPPORTED_OS`**           | Ubuntu 22.04 LTS or Debian 12                                          |
| **`PRIMARY_OS`**             | Ubuntu 22.04 LTS                                                       |
| **`DOCKER_SOURCE`**          | Docker official repo                                                   |
| **`DOCKER_APT_REPO_UBUNTU`** | https://download.docker.com/linux/ubuntu                               |
| **`DOCKER_APT_REPO_DEBIAN`** | https://download.docker.com/linux/debian                               |
| **`DOCKER_APT_REPO`**        | Pick from OS-specific values based on `PRIMARY_OS` (manual selection). |
| **`DOCKER_KEYRING_PATH`**    | /etc/apt/keyrings/docker.gpg                                           |
| **`LOG_RETENTION_STRATEGY`** | Docker log rotation                                                    |

## Decisions
| **Decision**                                                               | **Rationale**                                         | **Alternatives**                  | **Impact**                                                |
| -------------------------------------------------------------------------- | ----------------------------------------------------- | --------------------------------- | --------------------------------------------------------- |
| **Separate system packages (host) from non-system packages (containers).** | Keeps host minimal and repeatable; reduces drift. | Install app runtimes on host. | All app dependencies ship as images; host stays lean. |
| **Use `DOCKER_SOURCE` and `DOCKER_APT_REPO`.**                             | Stable vendor-supported Docker packages.          | Distro Docker packages.       | Docker updates follow vendor repo and pinning policy. |
| **Pin container images by digest (or immutable tags with enforcement).**   | Prevents silent retags and keeps builds deterministic. | Floating tags. | CI and deploy use the same immutable image references. |
| **Pin Docker Engine/Compose versions.**                                    | Host rebuilds stay repeatable across time.            | Latest packages.               | System packages are stable and auditable. |

## Definitions (optional)
- **System packages:** OS-level tools required to bootstrap and operate the VM (installed via apt).
- **Non-system packages:** App/runtime dependencies shipped as containers or images.

## Overview
- **Goal:** Separate system vs non-system packages to ensure deterministic VM builds.
- **Target users:** Single-VM admin/operator.
- **Business value:** Repeatable deployments with minimal host maintenance.

## Scope
- **In scope:** Host package list and pinning; container images and tagging policy; bootstrap and deploy steps.
- **Out of scope:** App workflow design; monitoring dashboards; multi-node HA; managed DB services.
- **Assumptions:** VM uses `PRIMARY_OS`; Docker Compose is the runtime for app packages.
- **Constraints:** No app runtime dependencies on host; secrets injected at deploy time only.

## Requirements
| **Type**           | **Requirement**                                               |
| ------------------ | ------------------------------------------------------------- |
| **Functional**     | Install host packages from `Apps/n8n-app/ops/system-packages.txt`.         |
| **Functional**     | Deploy app packages via Docker Compose and pinned image tags. |
| **Functional**     | Keep host and app inventories auditable in repo.              |
| **Non-functional** | Deterministic builds (no hidden dependencies).                |
| **Non-functional** | Minimal host footprint and secure defaults.                   |
| **Non-functional** | Idempotent deployment steps.                                  |

## Architecture
- **Components:** Host OS with apt package list; Docker engine + compose; app containers (n8n, Postgres, optional runner).
- **Data flow:** Repo config -> CI -> VM -> Docker Compose -> containers.
- **External dependencies:** Docker official repo; GitHub Actions; SSH.
- **Deployment model:** CI syncs repo and runs `docker compose up -d`.

## Version Pinning
- **Container images:** Use digest references (`image@sha256:...`) or immutable tag policy with CI enforcement.
- **Docker Engine/Compose:** Pin versions in `Apps/n8n-app/ops/system-packages.txt` or via apt preferences.

## Data Design
- **Entities:** `Apps/n8n-app/ops/system-packages.txt` for host inventory; `Apps/n8n-app/ops/package-audit.md` for audit notes.
- **Storage/retention:** Docker volumes in `/var/lib/n8n` for app data.

## Security
- **Threats:** Host drift; secret exposure; unpinned dependencies.
- **Mitigations:** Single source of truth + pinned images; SSH key auth only; secrets injected at deploy time via CI.

## Observability
- **Logging:** `LOG_RETENTION_STRATEGY` defines log rotation.
- **Metrics:** Container health only (no external monitoring).
- **Alerts:** Not implemented; manual checks.

## Testing Strategy
- **Unit:** Validate package list format.
- **Integration:** Bootstrap and deploy on VM.
- **E2E:** Confirm containers are healthy post-deploy.

## Rollout Plan
- **Milestones:** Baseline host packages and Docker install; app containers deployed and pinned.
- **Rollback:** Revert image tags and redeploy; snapshot VM before major host updates.

## Open Questions and Risks
- **Questions:** Do we need a staging VM to validate package updates?
- **Risks and mitigations:** Docker repo changes -> pin versions and track in `Apps/n8n-app/ops/package-audit.md`.
