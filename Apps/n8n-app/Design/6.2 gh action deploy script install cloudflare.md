# 6.2 GH Action: Deploy Script Install Cloudflare Design

## Summary
- **Goal:** Define how a GitHub-hosted runner installs Cloudflare client tools and connects to the VM via the tunnel.

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`RUNNER_TYPE`** | GitHub-hosted |
| **`CLOUDFLARE_CLIENT_TOOL`** | cloudflared |
| **`CLOUDFLARE_CLIENT_VERSION`** | Pinned in `Apps/n8n-app/ops/dependencies.md` (source of truth) |
| **`CLOUDFLARE_CLIENT_SOURCE`** | Cloudflare official install source |
| **`SSH_TARGET`** | VM via Cloudflare tunnel |
| **`CLOUDFLARE_TUNNEL_ENDPOINT`** | Tunnel hostname |
| **`CLOUDFLARE_CLIENT_ID`** | Cloudflare Access service token client ID |
| **`CLOUDFLARE_CLIENT_SECRET`** | Cloudflare Access service token client secret |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Use GitHub-hosted runners. | No self-hosted runner maintenance. | Self-hosted runner on VM. | Requires tunnel access to VM. |
| Install Cloudflare client on the runner per job. | Keeps runner stateless and reproducible. | Pre-bake runner image. | Adds install step per run. |
| Pin Cloudflare client version. | Deterministic behavior and rollback. | Use latest version. | Manual updates required. |

## Definitions (optional)
- **Cloudflare client:** `cloudflared` used by the runner to connect through the tunnel.

## Overview
- **Goal:** Enable SSH from GitHub-hosted runner to the VM via the Cloudflare tunnel.
- **Target users:** CI pipeline maintainers.
- **Business value:** Public runner access without exposing the VM directly.

## Scope
- **In scope:** Runner type; Cloudflare client install; tunnel-based SSH target.
- **Out of scope:** Cloudflare tunnel creation; VM-side cloudflared setup.
- **Assumptions:** Cloudflare tunnel is live; SSH is configured on the VM.
- **Constraints:** Pin client version; no secrets written to disk.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Use GitHub-hosted runner for deploy workflow. |
| **Functional** | Install `CLOUDFLARE_CLIENT_TOOL` at `CLOUDFLARE_CLIENT_VERSION` from `CLOUDFLARE_CLIENT_SOURCE`. |
| **Functional** | SSH to `SSH_TARGET` via `CLOUDFLARE_TUNNEL_ENDPOINT` using Cloudflare Access service token auth. |
| **Functional** | Source `CLOUDFLARE_CLIENT_VERSION` from `Apps/n8n-app/ops/dependencies.md`. |
| **Non-functional** | Avoid logging tunnel credentials. |
| **Non-functional** | Keep client version pinned and recorded. |

## Architecture
- **Components:** GitHub-hosted runner; Cloudflare client; VM SSH server; Cloudflare tunnel.
- **Data flow:** Runner installs client -> uses Access service token -> connects to tunnel endpoint -> SSH to VM -> deploy commands run.
- **External dependencies:** Cloudflare tunnel service.
- **Deployment model:** CI job step before deploy.
- **Diagram description:** GitHub runner uses a Cloudflare client to reach the VM over the tunnel for SSH.

## Data Design
- **Entities:** Cloudflare client version; tunnel endpoint hostname.
- **Relationships:** Runner uses Access service token credentials with the tunnel endpoint to reach the VM via SSH.
- **Storage/retention:** Version recorded in repo; endpoint stored in GitHub variables.

## Security
- **Threats:** Tunnel endpoint leakage; client version drift; Access token exposure.
- **Mitigations:** Secret masking; pinned versions; access scoped to tunnel.
- **Secrets:** Cloudflare Access service token credentials.

## Observability
- **Logging:** Log connection success/failure without secrets.
- **Metrics:** None.
- **Alerts:** Not implemented.

## Testing Strategy
- **Unit:** Validate required variables exist before SSH step.
- **Integration:** Run workflow to confirm SSH connects via tunnel.
- **E2E:** Full deploy using tunnel-based SSH.

## Rollout Plan
- **Milestones:** Add runner type; install client step; configure tunnel endpoint; verify SSH.
- **Rollback:** Remove client step and disable tunnel-based SSH.

## Risks and Mitigations
- **Risk:** Client install source changes. **Mitigation:** Pin version and review updates.
- **Risk:** Tunnel endpoint misconfiguration. **Mitigation:** Validate endpoint in a pre-check step.

## Open Questions
- **Question:** Should `CLOUDFLARE_CLIENT_VERSION` match the VM `CLOUDFLARE_IMAGE_TAG`?
