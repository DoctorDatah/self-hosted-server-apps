# n8n Deployment Design (VM)

## Summary
- **Goal:** Define the deployment flow for n8n on a single VM using Docker Compose and CI.

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`DEPLOY_RUNTIME`** | Docker Compose |
| **`N8N_IMAGE`** | n8nio/n8n |
| **`N8N_IMAGE_TAG`** | Pinned in `ops/dependencies.md` (source of truth) |
| **`DB_ENGINE`** | Postgres |
| **`POSTGRES_IMAGE`** | postgres |
| **`POSTGRES_IMAGE_TAG`** | Pinned in `ops/dependencies.md` (source of truth) |
| **`N8N_ENV_SOURCE`** | CI variables and Infisical secrets |
| **`N8N_DATA_PATH`** | /var/lib/n8n |
| **`POSTGRES_DATA_PATH`** | /var/lib/n8n/postgres |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Use Docker Compose for n8n and Postgres. | Matches package handling and deployment flow. | systemd services. | Compose file is the runtime source of truth. |
| Pin image tags via `ops/dependencies.md`. | Deterministic deploys and auditability. | Floating tags. | Manual update process required. |
| Inject runtime env via CI and Infisical. | Keep secrets out of repo. | Local `.env` on VM. | Requires CI availability. |

## Definitions (optional)
- **n8n:** Workflow automation application deployed as a container.
- **Compose stack:** The n8n + Postgres services defined in `docker-compose.yml`.

## Overview
- **Goal:** Deploy and maintain n8n on a single VM with repeatable, pinned releases.
- **Target users:** VM operator and CI maintainers.
- **Business value:** Stable deployments with centralized configuration.

## Scope
- **In scope:** Compose stack, env injection, SSH-based CI deploy, data persistence.
- **Out of scope:** HA/multi-node; managed Postgres; app workflow design; UI branding.
- **Assumptions:** VM has Docker installed; SSH access via Cloudflare tunnel; secrets available via Infisical.
- **Constraints:** No secrets stored in repo; pinned versions only.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Deploy n8n and Postgres using Docker Compose. |
| **Functional** | Source image tags from `ops/dependencies.md`. |
| **Functional** | Inject environment variables from CI and Infisical. |
| **Functional** | Persist data at `N8N_DATA_PATH` and `POSTGRES_DATA_PATH`. |
| **Non-functional** | No secrets written to disk on the VM. |
| **Non-functional** | Deployment steps are idempotent. |

## Architecture
- **Components:** VM; Docker engine; Docker Compose; n8n container; Postgres container; CI runner.
- **Data flow:** CI gathers env -> SSH to VM -> Compose up -> containers use persisted volumes.
- **External dependencies:** GitHub Actions; Infisical; Docker registry.
- **Deployment model:** CI job runs remote deploy commands via SSH.
- **Diagram description:** CI delivers env and runs compose on VM; n8n container connects to Postgres volume.

## Data Design
- **Entities:** Compose file; env variables; n8n and Postgres volumes.
- **Relationships:** n8n uses Postgres service for persistence; volumes keep state.
- **Storage/retention:** VM volumes at `N8N_DATA_PATH` and `POSTGRES_DATA_PATH`.

## Security
- **Threats:** Secret leakage; unpinned images; exposed UI.
- **Mitigations:** Infisical secrets; pinned tags; Cloudflare tunnel ingress.
- **Secrets:** n8n credentials and DB credentials sourced at runtime.

## Observability
- **Logging:** Container logs via `docker compose logs`.
- **Metrics:** Container health checks only.
- **Alerts:** Not implemented; manual checks.

## Testing Strategy
- **Unit:** Validate compose and env templates.
- **Integration:** Deploy on VM and confirm container health.
- **E2E:** Access n8n UI and run a test workflow.

## Rollout Plan
- **Milestones:** Create compose stack; add env mapping; deploy to VM; validate health.
- **Rollback:** Revert tags in `ops/dependencies.md` and redeploy.

## Risks and Mitigations
- **Risk:** DB schema mismatch after upgrades. **Mitigation:** Pin versions and follow n8n upgrade notes.
- **Risk:** Env misconfiguration. **Mitigation:** Pre-deploy validation in CI.

## Open Questions
- **Question:** Where should the compose file live in the repo (e.g., `ops/compose/`)?
