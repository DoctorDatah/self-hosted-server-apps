# Implementation Structure Design

## Summary
- **Goal:** Define a comprehensive repo structure: folders, files, and what belongs where.

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`REPO_ROOT`** | Repo root |
| **`APP_ROOT`** | `Apps/n8n-app/` |
| **`OPS_DIR`** | `Apps/n8n-app/ops/` |
| **`DESIGN_DIR`** | `Apps/n8n-app/Design/` |
| **`WORKFLOW_DIR`** | `.github/workflows/` |
| **`DOCS_DIR`** | `2. AI/` |
| **`DEPLOY_DIR`** | `Apps/n8n-app/ops/deploy/` |
| **`COMPOSE_DIR`** | `Apps/n8n-app/ops/compose/` |
| **`SECRETS_REF_DIR`** | `Apps/n8n-app/ops/secrets/` (references only, no secrets) |
| **`REQUIREMENTS_DIR`** | `Apps/n8n-app/requirements/` |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Keep ops files under `OPS_DIR`. | Centralized operational assets. | Split across service folders. | Standardized paths for automation. |
| Keep design docs under `DESIGN_DIR`. | Clear separation of design vs implementation. | Store with code. | Easier review and navigation. |
| Keep CI workflows under `WORKFLOW_DIR`. | GitHub Actions convention. | Custom workflow folder. | Compatible with GitHub Actions. |
| Separate design guidance in `DOCS_DIR`. | Avoid mixing instructions with implementation. | Keep in README. | Clearer documentation boundaries. |

## Definitions (optional)
- **Ops files:** Configuration and assets used to operate the VM and deploy services.

## Overview
- **Goal:** Provide a deterministic structure for implementation artifacts.
- **Target users:** Repo maintainers and CI maintainers.
- **Business value:** Predictable paths and less configuration drift.

## Scope
- **In scope:** Folder layout; file placement rules; ownership by folder.
- **Out of scope:** Code style rules; app-level architecture.
- **Assumptions:** Repo is the single source of truth.
- **Constraints:** No secrets committed to the repo.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Store deployment artifacts in `OPS_DIR`. |
| **Functional** | Store workflows in `WORKFLOW_DIR`. |
| **Functional** | Store design docs in `DESIGN_DIR`. |
| **Functional** | Store AI guidance in `DOCS_DIR`. |
| **Non-functional** | Keep paths stable to avoid CI drift. |
| **Non-functional** | Keep secrets out of version control. |

## Architecture
- **Components:** Repo root; ops folder; workflows; design docs; AI docs.
- **Data flow:** CI and scripts reference fixed paths during deploy.
- **External dependencies:** GitHub Actions.
- **Deployment model:** CI uses paths defined here.
- **Diagram description:** Repo with standardized top-level folders and fixed paths referenced by CI.

## Data Design
- **Entities:** Ops files; workflow definitions; design docs; AI docs.
- **Relationships:** Workflows call scripts and configs in ops folder.
- **Storage/retention:** Repo history is the audit trail.

## Security
- **Threats:** Secret leakage; accidental path changes.
- **Mitigations:** Repo reviews; avoid secrets in tracked files.
- **Secrets:** Stored only in external secret managers.

## Observability
- **Logging:** CI logs on workflow runs.
- **Metrics:** None.
- **Alerts:** Not implemented.

## Testing Strategy
- **Unit:** Validate expected directories exist in CI pre-checks.
- **Integration:** Run a dry-run deploy using defined paths.
- **E2E:** Full deploy using the standardized structure.

## Rollout Plan
- **Milestones:** Confirm directory layout; update workflows to use defined paths.
- **Rollback:** Revert to previous folder layout and update workflows.

## Open Questions
- **Question:** Do we need a dedicated `scripts/` directory under `OPS_DIR`?

## Folder Structure (canonical)
- **Hierarchy (intended):**
```text
repo-root/
├── 1. Human/
├── 2. AI/
│   └── Code Design and Implementation Documention Guides/
│       ├── 1. reading guide for ai and syntax for developer.md
│       ├── 2a. design document writing guide.md
│       ├── 2b. general document formatting guide.md
│       ├── 3. implementation document writing guide.md
│       └── 4. implementation document guide.md
├── .github/
│   └── workflows/
│       └── deploy.yml
└── Apps/
    └── n8n-app/
        ├── Design/
        │   ├── 0. scope.md
        │   ├── 1. package handling design.md
        │   ├── 2. cloudflare installation design.md
        │   ├── 3. gh repo cloudflare pinned version.md
        │   ├── 4. ssh setup design.md
        │   ├── 5. gh variables and secrets for infisical.md
        │   ├── 6.1 gh action infisical install and secret fetch.md
        │   ├── 6.2 gh action deploy script install cloudflare.md
        │   ├── 7. n8n deployment design.md
        │   ├── 8. google drive folder and service account setup design.md
        │   ├── 9. github action backup to google drive design.md
        │   ├── 10. restore from google drive design.md
        │   └── 11. implementation structure design.md
        ├── requirements/
        │   ├── vm_requirements.txt
        │   ├── n8n_container_requirements.txt
        │   └── github_runner_requirements.txt
        └── ops/
            ├── cloudflared/
            │   └── config.yml
            ├── compose/
            │   ├── n8n.compose.yml
            │   └── cloudflared.compose.yml
            ├── deploy/
            │   ├── deploy.sh
            │   └── validate-env.sh
            ├── ssh/
            │   └── known_hosts
            ├── secrets/
            │   └── infisical.md
            └── dependencies.md
```

## File Descriptions
| **Path** | **Purpose** |
| --- | --- |
| `2. AI/Code Design and Implementation Documention Guides/1. reading guide for ai and syntax for developer.md` | AI reading rules and markers. |
| `2. AI/Code Design and Implementation Documention Guides/2a. design document writing guide.md` | How to write design docs. |
| `2. AI/Code Design and Implementation Documention Guides/2b. general document formatting guide.md` | Formatting rules for repo docs. |
| `2. AI/Code Design and Implementation Documention Guides/3. implementation document writing guide.md` | Implementation doc table format rules. |
| `2. AI/Code Design and Implementation Documention Guides/4. implementation document guide.md` | Implementation doc usage and status rules. |
| `Apps/n8n-app/Design/0. scope.md` | Project scope and sequencing. |
| `Apps/n8n-app/Design/1. package handling design.md` | Host vs container package policy. |
| `Apps/n8n-app/Design/2. cloudflare installation design.md` | Cloudflare tunnel setup plan. |
| `Apps/n8n-app/Design/3. gh repo cloudflare pinned version.md` | Pin storage for cloudflared image. |
| `Apps/n8n-app/Design/4. ssh setup design.md` | SSH model for CI to VM. |
| `Apps/n8n-app/Design/5. gh variables and secrets for infisical.md` | GitHub vars/secrets for Infisical. |
| `Apps/n8n-app/Design/6.1 gh action infisical install and secret fetch.md` | CI step to install and use Infisical. |
| `Apps/n8n-app/Design/6.2 gh action deploy script install cloudflare.md` | CI step to use Cloudflare client for SSH. |
| `Apps/n8n-app/Design/7. n8n deployment design.md` | n8n + Postgres deploy flow. |
| `Apps/n8n-app/Design/8. google drive folder and service account setup design.md` | Drive folder and service account setup. |
| `Apps/n8n-app/Design/9. github action backup to google drive design.md` | Backup workflow design (Google Drive). |
| `Apps/n8n-app/Design/10. restore from google drive design.md` | Restore workflow design (Google Drive). |
| `Apps/n8n-app/Design/11. implementation structure design.md` | Repo structure blueprint. |
| `.github/workflows/deploy.yml` | CI deploy workflow entrypoint. |
| `Apps/n8n-app/ops/cloudflared/config.yml` | Cloudflared config (no secrets). |
| `Apps/n8n-app/ops/compose/n8n.compose.yml` | Compose stack for n8n + Postgres. |
| `Apps/n8n-app/ops/compose/cloudflared.compose.yml` | Compose service for cloudflared. |
| `Apps/n8n-app/ops/deploy/deploy.sh` | Deploy script run over SSH. |
| `Apps/n8n-app/ops/deploy/validate-env.sh` | Pre-deploy env validation. |
| `Apps/n8n-app/ops/ssh/known_hosts` | VM host key fingerprint list. |
| `Apps/n8n-app/ops/secrets/infisical.md` | Secret references and naming. |
| `Apps/n8n-app/requirements/vm_requirements.txt` | Environment-specific pinned host packages for the VM. |
| `Apps/n8n-app/requirements/n8n_container_requirements.txt` | Environment-specific pinned container requirements for n8n. |
| `Apps/n8n-app/requirements/github_runner_requirements.txt` | Environment-specific pinned requirements for the GitHub runner. |
| `Apps/n8n-app/ops/dependencies.md` | Pinned versions for images/tools. |
- **`Design/`**: Design docs for each step (1..N) and scope.
- **`AI/`**: AI guidance, syntax rules, and doc templates.
- **`.github/workflows/`**: CI workflows; no secrets.
- **`Apps/n8n-app/ops/`**: Operational assets and configs used by CI/VM.
- **`Apps/n8n-app/ops/compose/`**: Docker Compose files and related templates.
- **`Apps/n8n-app/ops/deploy/`**: Deploy scripts and helper files.
- **`Apps/n8n-app/ops/ssh/`**: SSH known_hosts and public key material only.
- **`Apps/n8n-app/ops/cloudflared/`**: Cloudflare tunnel config (no secrets).
- **`Apps/n8n-app/ops/secrets/`**: Secret references, naming, and access notes only.
- **`Apps/n8n-app/requirements/`**: Environment-specific pinned requirement files.
- **`Apps/n8n-app/ops/dependencies.md`**: Pinned versions for images and tools.

## File Placement Rules
- **Compose files:** `Apps/n8n-app/ops/compose/` only.
- **Deploy scripts:** `Apps/n8n-app/ops/deploy/` only.
- **Pinned versions:** `Apps/n8n-app/ops/dependencies.md` only.
- **Host package pins:** `Apps/n8n-app/requirements/` only.
- **Cloudflare config:** `Apps/n8n-app/ops/cloudflared/config.yml` only, no tokens.
- **SSH host keys:** `Apps/n8n-app/ops/ssh/known_hosts` only.
- **CI workflows:** `.github/workflows/` only.
- **Design docs:** `Apps/n8n-app/Design/` only.
- **AI guidance:** `2. AI/` only.
