# GH Variables and Secrets for Infisical Design

## Summary
- **Goal:** Define the GitHub variables and secrets required to integrate Infisical in CI.

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`INFISICAL_ENV`** | production |
| **`INFISICAL_PATH`** | /n8n |
| **`INFISICAL_PROJECT_ID`** | Set in GitHub variables |
| **`INFISICAL_TOKEN`** | Stored as GitHub secret |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Store `INFISICAL_TOKEN` as a GitHub secret. | Secrets stay out of repo and logs. | Store token on VM. | CI is the only access path. |
| Store `INFISICAL_ENV`, `INFISICAL_PATH`, and `INFISICAL_PROJECT_ID` as GitHub variables. | Centralized, non-secret configuration. | Hardcode in workflows. | Changes are auditable in repo settings. |

## Definitions (optional)
- **Infisical:** Secrets manager used by CI to fetch runtime secrets.
- **GitHub variables:** Repo-level or environment-level non-secret values.

## Overview
- **Goal:** Make Infisical configuration available to GitHub Actions without leaking secrets.
- **Target users:** CI pipeline maintainers and VM operator.
- **Business value:** Centralized secrets management with deterministic CI inputs.

## Scope
- **In scope:** Defining required variables and secrets in GitHub; naming and values.
- **Out of scope:** Infisical project setup; policy configuration; secret contents.
- **Assumptions:** GitHub Actions is used for deployment; Infisical access is required for secrets at deploy time.
- **Constraints:** `INFISICAL_TOKEN` must never be stored in repo or workflow files.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Define `INFISICAL_TOKEN` as a GitHub secret. |
| **Functional** | Define `INFISICAL_ENV` as a GitHub variable. |
| **Functional** | Define `INFISICAL_PATH` as a GitHub variable. |
| **Functional** | Define `INFISICAL_PROJECT_ID` as a GitHub variable. |
| **Non-functional** | Prevent secrets from being written to disk in CI. |
| **Non-functional** | Keep variable names stable for workflows. |

## Architecture
- **Components:** GitHub Actions; GitHub secrets/variables store; Infisical API.
- **Data flow:** Workflow reads variables -> uses `INFISICAL_TOKEN` -> fetches secrets from Infisical -> deploy steps consume secrets.
- **External dependencies:** Infisical service; GitHub Actions.
- **Deployment model:** CI uses Infisical at deploy time.
- **Diagram description:** GitHub Actions pulls config from GitHub variables and a token from secrets, then fetches secrets from Infisical.

## Data Design
- **Entities:** `INFISICAL_TOKEN` (secret); `INFISICAL_ENV`, `INFISICAL_PATH`, `INFISICAL_PROJECT_ID` (variables).
- **Relationships:** Workflow combines variables with token to request secrets from Infisical.
- **Storage/retention:** Stored in GitHub repo settings; audit via GitHub change history.

## Security
- **Threats:** Token leakage; misuse of incorrect project or path.
- **Mitigations:** Secret masking; least-privilege token; environment scoping.
- **Secrets:** `INFISICAL_TOKEN`.

## Observability
- **Logging:** Avoid logging secrets; log only Infisical fetch success/failure.
- **Metrics:** None.
- **Alerts:** Not implemented.

## Testing Strategy
- **Unit:** Validate required variables exist before running deploy jobs.
- **Integration:** Run a workflow that fetches a test secret from Infisical.
- **E2E:** Full deploy path with Infisical secrets.

## Rollout Plan
- **Milestones:** Create GitHub variables; create `INFISICAL_TOKEN` secret; update workflows to reference them.
- **Rollback:** Remove variables/secrets and revert workflow changes.

## Risks and Mitigations
- **Risk:** Wrong `INFISICAL_PATH` or `INFISICAL_PROJECT_ID` breaks secrets fetch. **Mitigation:** Validate in CI before deploy.
- **Risk:** Token expires or is revoked. **Mitigation:** Rotate token and re-run pipeline.

## Open Questions
- **Question:** Should variables be set at repo or environment scope?
