# 6.1 GH Action: Infisical Install and Secret Fetch Design

## Summary
- **Goal:** Define how the GitHub Actions runner installs Infisical, authenticates, and fetches Cloudflare credentials.

## Global Variables (select here)
| **Variable** | **Value** |
| --- | --- |
| **`INFISICAL_ENV`** | production |
| **`INFISICAL_PATH`** | /n8n |
| **`INFISICAL_PROJECT_ID`** | GitHub variable |
| **`INFISICAL_TOKEN`** | GitHub secret |
| **`INFISICAL_CLI_VERSION`** | Pin to a specific version (manual selection) |
| **`CLOUDFLARE_CLIENT_ID`** | Retrieved from Infisical |
| **`CLOUDFLARE_CLIENT_SECRET`** | Retrieved from Infisical |
| **`CLOUDFLARE_CREDS_OUTPUT`** | Env vars for deploy step |

## Decisions
| **Decision** | **Rationale** | **Alternatives** | **Impact** |
| --- | --- | --- | --- |
| Install Infisical CLI on the runner during the workflow. | Keeps runner stateless and reproducible. | Pre-bake Infisical on runner image. | Adds install step per run. |
| Authenticate using GitHub variables and secrets. | Centralized configuration without hardcoding. | Hardcode values in workflow. | Requires secrets management in GitHub. |
| Fetch Cloudflare client credentials from Infisical. | Keeps sensitive values out of GitHub. | Store Cloudflare creds in GitHub secrets. | Adds Infisical dependency. |

## Definitions (optional)
- **Infisical CLI:** Command-line tool to fetch secrets from Infisical.
- **Runner:** GitHub Actions execution environment.

## Overview
- **Goal:** Use Infisical in CI to obtain Cloudflare credentials needed by the deploy script.
- **Target users:** CI pipeline maintainers.
- **Business value:** Centralized secrets management with minimal GitHub secrets exposure.

## Scope
- **In scope:** Installing Infisical CLI; authenticating; fetching Cloudflare client ID/secret.
- **Out of scope:** Infisical project setup; Cloudflare application setup.
- **Assumptions:** GitHub variables/secrets from step 5 exist; runner has network access to Infisical.
- **Constraints:** No secrets written to disk; use env vars only.

## Requirements
| **Type** | **Requirement** |
| --- | --- |
| **Functional** | Install Infisical CLI `INFISICAL_CLI_VERSION` during the workflow run. |
| **Functional** | Authenticate using `INFISICAL_ENV`, `INFISICAL_PATH`, `INFISICAL_PROJECT_ID`, and `INFISICAL_TOKEN`. |
| **Functional** | Fetch `CLOUDFLARE_CLIENT_ID` and `CLOUDFLARE_CLIENT_SECRET` from Infisical. |
| **Non-functional** | Prevent secrets from being written to disk. |
| **Non-functional** | Avoid logging secrets in workflow output. |
| **Non-functional** | Pass Cloudflare credentials only through `CLOUDFLARE_CREDS_OUTPUT`. |

## Architecture
- **Components:** GitHub Actions runner; Infisical CLI; Infisical API; deploy script.
- **Data flow:** Runner installs CLI -> authenticates -> fetches Cloudflare credentials -> exports via `CLOUDFLARE_CREDS_OUTPUT` for deploy.
- **External dependencies:** Infisical service.
- **Deployment model:** CI job step before deploy.
- **Diagram description:** Runner fetches secrets from Infisical and passes them to the deploy script as env vars.

## Data Design
- **Entities:** GitHub variables/secrets; Infisical secret keys for Cloudflare.
- **Relationships:** Runner uses GitHub config to access Infisical and retrieves Cloudflare credentials.
- **Storage/retention:** Secrets exist in Infisical; only in-memory on runner.

## Security
- **Threats:** Secrets leaked in logs; mis-scoped token.
- **Mitigations:** Secret masking; least-privilege token; no disk writes.
- **Secrets:** `INFISICAL_TOKEN`, `CLOUDFLARE_CLIENT_ID`, `CLOUDFLARE_CLIENT_SECRET`.

## Observability
- **Logging:** Log success/failure of secret fetch without values.
- **Metrics:** None.
- **Alerts:** Not implemented.

## Testing Strategy
- **Unit:** Validate required GitHub vars/secrets exist before running the install step.
- **Integration:** Run a workflow that installs Infisical and fetches a test secret.
- **E2E:** Full deploy workflow using fetched Cloudflare credentials.

## Rollout Plan
- **Milestones:** Add workflow step to install Infisical; authenticate; fetch Cloudflare creds; pass to deploy.
- **Rollback:** Remove Infisical steps and revert to previous secret source.

## Risks and Mitigations
- **Risk:** Infisical CLI install fails. **Mitigation:** Pin version and cache installer if supported.
- **Risk:** Token permissions too broad. **Mitigation:** Restrict token scope to required secrets.

## Open Questions
- **Question:** Should `CLOUDFLARE_CREDS_OUTPUT` be `GITHUB_ENV` or a step output?
